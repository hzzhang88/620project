---
title: "pj2"
author: '620'
date: "4/10/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
library(ggplot2)
library(tidyverse)
```

```{r}
df_sc= read_xlsx('rawdata/620W22-Project2-Data.xlsx',sheet = 1)
df_bs= read_xlsx('rawdata/620W22-Project2-Data.xlsx',sheet = 2)
df_bs =df_bs[,1:14]
df_sc['LOAD'] = df_sc$Tot.Soc.Time/df_sc$Tot.Scr.Time
df_sc['DUR'] = df_sc$Tot.Scr.Time/df_sc$Pickups
```

# generate the baseline/intervention phase
```{r}
df_sc = df_sc %>% mutate(phase = case_when(
  Time <= 13 ~ 'baseline',
  Time<=20 ~'A',
  Time <= 27 ~ 'B',
  Time <=30 ~ 'E'
))
```

# check  the data quality 
the total screen time should be greater than social screen time
```{r}
sum(df_sc$Tot.Scr.Time < df_sc$Tot.Soc.Time, na.rm = T)
df_sc[df_sc$Tot.Scr.Time < df_sc$Tot.Soc.Time,]
df_sc[(df_sc$ID == 25 & df_sc$Time ==13),'Tot.Scr.Time'] = 207
df_sc[(df_sc$ID == 25 & df_sc$Time ==13),'Tot.Soc.Time'] = 164
```

# convert the first pickup time into a numeric data
```{r}
df_sc$first_pk = unlist(lapply(df_sc[['Pickup.1st']],function(x) as.numeric(strsplit(x, ':')[[1]][1])*60 + 
                          as.numeric(strsplit(x, ':')[[1]][2]) ))
```


# generate the average values of outcomes grouped by the ID and phase 
as for the missing data, we can conduct the robust analysis.
```{r}
df_sc = df_sc %>% group_by(ID, phase ) %>% mutate(avg_scr = mean(Tot.Scr.Time, na.rm = T),
                                                   avg_soc = mean(Tot.Soc.Time, na.rm = T),
                                                   avg_pk = mean(Pickups, na.rm = T),
                                                  avg_firstpk = mean(first_pk, na.rm = T),
                                                   avg_load = mean(LOAD, na.rm = T),
                                                   avg_dur = mean(DUR, na.rm = T)
                                                   )
```

#
```{r}
pre_avg = df_sc %>%group_by(ID) %>% filter(phase == 'baseline') %>% summarise(total_soc_mean = mean(Tot.Soc.Time)) %>% mutate(phase = 'P')
post_avg_A = df_sc %>%group_by(ID) %>% filter(phase == 'A') %>% summarise(total_soc_mean= mean(Tot.Soc.Time)) %>% mutate(phase = 'A')
post_avg_B = df_sc %>%group_by(ID) %>% filter(phase == 'B') %>% summarise(total_soc_mean = mean(Tot.Soc.Time,na.rm = T)) %>% mutate(phase = 'B')
post_avg_E = df_sc %>%group_by(ID) %>% filter(phase == 'E') %>% summarise(total_soc_mean = mean(Tot.Soc.Time)) %>% mutate(phase = 'E')


pre_post_diff = data.frame(ID = post_avg_A$ID,
                           A = post_avg_A$total_soc_mean-pre_avg$total_soc_mean,
                           B= post_avg_B$total_soc_mean-pre_avg$total_soc_mean,
                           E = post_avg_E$total_soc_mean-pre_avg$total_soc_mean
)
```


# merge pre_post_diff with baseline table
```{r}
data = full_join(pre_post_diff,df_bs, by = "ID")
head(data)
```
# pivot the columns
```{r}
data = data[ complete.cases(data),]
data = data %>% pivot_longer(c('A','B','E'),names_to ='phase', values_to = 'diff')
```



# model

$$\begin{aligned}
Y_i = \beta_1I(treatment = A) + \beta_2I(treatment = B) + \beta_3I(treatment =E) + \beta_4x_{1i}+\beta_5x_{2i}+....
\end{aligned}$$

```{r}
fit1 = lm(diff~ -1+.,data= data)
summary(fit1)
```
```{r}
library(MASS)
step.aic = stepAIC(fit1,direction = 'both')
```

```{r}
fit3 = stepAIC(fit1,scope = list(lower = ~-1+phase,upper = fit1),trace =FALSE)
summary(fit3)
```

