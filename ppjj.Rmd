---
title: "620pj"
author: "Han Zhang"
date: "2/24/2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggplot2)
library(tidyr)
library(readr)
library(readxl)
library(lubridate)
```

### 把clean data 导入分成三个table t1,t2,t3
### 把三个table 融合成一个table t0
```{r}
t1 = read_excel(path = './rawdata/t1.xlsx',
                col_types = c("date","numeric","numeric","numeric","date",'text','logical'))
t2 = read_excel(path = './rawdata/t2.xlsx',
                  col_types = c("date","numeric","numeric","numeric","date",'text','logical'))
t3 = read_excel(path = './rawdata/t3.xlsx',
                col_types = c("date","numeric","numeric","numeric","date",'text','logical'))
for (i in 1:length(t3$date)) {
  t3$pickups_1st[i] = ymd_hms(paste(as.character(t3$date[i]), strsplit(as.character(t3$pickups_1st[i]),split = " ")[[1]][2]))
}

colnames(t2) = c('date',"total_st","social_st","pickups","pickups_1st","weekday","if_weekend")
for (i in 1:length(t2$date)) {
  t2$pickups_1st[i] = ymd_hms(paste(as.character(t2$date[i]), strsplit(as.character(t2$pickups_1st[i]),split = " ")[[1]][2]))
}

t1 = cbind(t1,id = 1)
t2 = cbind(t2,id = 2)
t3 = cbind(t3,id = 3)
tt = rbind(t1,t2,t3)
```



```{r}
# new_t= list()
# hm_to_min = function(hm){
#   splt = strsplit(hm,'h')[[1]]
#   hr = as.numeric(splt[1])
#   mn = as.numeric(strsplit(splt[2],'m'))
#   return(hr*60 + mn)
# }
# 
# for (j in 1:length(t)) {
#   st = t[[j]]
#   for (i in 1:length(st$Date)) {
#   st$Pickup.1st[i] = ymd_hms(paste(as.character(st$Date[i]), strsplit(as.character(st$pickups_1st[i]),split = " ")[[1]][2]))
# }
#   st$Total.ST.true =unlist(lapply(st$Total.ST,hm_to_min))
#   st$Social.ST.true = unlist(lapply(st$Social.ST, hm_to_min))
#   st = st%>%mutate(Total.ST.match =Total.ST.true == Total.ST.min,
#                  Social.ST.match = Social.ST.true == Social.ST.min) %>% relocate(
#                    Date, Total.ST, Total.ST.min, Total.ST.match, Social.ST, Social.ST.min, Social.ST.match
#                  )
#   st$weekday = weekdays(st$Date,abbreviate = T)
#   st = st%>%mutate(if_weekend = weekday %in% c('Sun','Sat'))
#   new_t[[j]] = st
# }

```




### federater learning
先算各自outcome的均值y1 y2 y3 汇总得到ybar
算 predictor的均值x1，x2,x3  算得xbar
n1,n2,n3 reprsent the number of observaion
```{r}
n1 = length(t1)
n2 = length(t2)
n3 = length(t3)
n = n1+n2+n3
x = 'pickups'

x_bar = (sum(t1$x) +sum(t2$x) +sum(t3$x))/n
y_bar = (sum(t1$y) +sum(t2$y) +sumt3$y))/n

```
返回均值 用于算ssx ssy ssxy

```{r}
ssx1 = sum((t1$x - x_bar)^2)
ssx2 = sum((t2$x - x_bar)^2)
ssx3 = sum((t3$x - x_bar)^2)

ssx = ssx1+ssx2+ssx3

ssy1 = sum((t1$y - y_bar)^2)
ssy2 = sum((t2$y - y_bar)^2)
ssy3 = sum((t3$y - y_bar)^2)
ssy = ssy1+ssy2+ssy3

ssxy1 = sum((t1$x - x_bar)*(t1$y - y_bar))
ssxy2 = sum((t2$x - x_bar)*(t1$y - y_bar))
ssxy3 = sum((t3$x - x_bar)*(t1$y - y_bar))

ssxy = ssxy1 +ssxy2+ ssxy3
  
beta1_hat = ssxy/ssx
beta0_hat = y_bar- beta1_hat*x_bar
```

把返回的beta1 beta0 用于算各自的fitted value 的MSE
和总体的mse

```{r}
MSE1 = (t1$y - t1$x1 * beta1_hat-beta0_hat)^2
MSE2 = (t2$y - t2$x1 * beta1_hat-beta0_hat)^2
MSE3 = (t3$y - t3$x1 * beta1_hat-beta0_hat)^2

MSE_total = MSE1+MSE2+MSE3
```

将返回的mse_total用于计算var

```{r}
var_beta1_hat = MSE_total/ssx
```



